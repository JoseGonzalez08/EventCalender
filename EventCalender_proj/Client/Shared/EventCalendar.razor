@page "/c"
@using EventCalender_proj.Client.Shared.Components;
@using EventCalender_proj.Client.Shared.Models;
@using MudBlazor;
@using MudBlazor.Services;
@using System.Globalization
@inject IDialogService DialogService;
@inject HttpClient Http

<div class="controls" style="display: flex; justify-content: flex-end; gap: 1%;">
    <MudSelect T="string" Label="Select Month" Value="@selectedMonth" ValueChanged="OnMonthChange" Variant="Variant.Outlined" Dense="true" Immediate="true">
        @foreach (var month in CultureInfo.CurrentCulture.DateTimeFormat.MonthNames.Where(m => !string.IsNullOrEmpty(m)))
        {
            <MudSelectItem Value="@month">@month</MudSelectItem>
        }
    </MudSelect>

    <MudNumericField T="int" Label="Year" Value="@selectedYear" ValueChanged="OnYearChange" Immediate="true" Variant="Variant.Outlined" Dense="true" />

</div>


<MudTable Items="@calendar" Breakpoint="Breakpoint.Sm">
    <HeaderContent>
        <MudTh></MudTh>
        @{
            string[] daysOfWeek = new string[] { "Monday", "Tuesday", "Wednesday", "Thursday", "Friday", "Saturday", "Sunday" };
            foreach (var day in daysOfWeek)
            {
                <MudTh>@day</MudTh>
            }
        }
    </HeaderContent>
    <RowTemplate Context="week">
        <MudTd DataLabel=""></MudTd>
        @for (int i = 0; i <= 6; i++)
        {
            string day = week[i] == 0 ? "" : week[i].ToString();
            bool hasEvent = eventDays.Contains(week[i]);
            <MudTd DataLabel="@(((DayOfWeek)(i)).ToString())" Class="boxed-cell" @onclick="() => OpenDialog(day)">
                @day
                @if (hasEvent)
                {
                    <span class="dot"></span>
                }
            </MudTd>
        }
    </RowTemplate>
</MudTable>
<style>
    .boxed-cell {
        border: 1px solid #ccc;
        padding: 0;
        text-align: center;
        background-color: #f5f5f5;
        height: 100px; /* Adjust the height as needed */
    }

    .cell-content {
        height: 100%;
        display: flex;
        flex-direction: column;
        justify-content: center;
        padding: 5px;
        font-size: 14px;
    }

    .day-number {
        font-weight: bold;
    }
    .mud-table-cell{
        padding: 0
    }

    .dot {
        height: 10px;
        width: 10px;
        background-color: red;
        border-radius: 50%;
        display: inline-block;
        margin-left: 5px;
    }
</style>
@code {
    List<int[]> calendar;
    DateTime currentMonth;
    string selectedMonth;
    int selectedYear;
    List<int> eventDays = new List<int>();

    protected override void OnInitialized()
    {
        currentMonth = DateTime.Now; // start with the current month
        selectedMonth = currentMonth.ToString("MMMM");
        selectedYear = currentMonth.Year;
        GenerateCalendar();
    }

    void GenerateCalendar()
    {
        // clear out the old calendar
        calendar = new List<int[]>();
        int daysInMonth = DateTime.DaysInMonth(currentMonth.Year, currentMonth.Month);
        int startDayOfWeek = (int)new DateTime(currentMonth.Year, currentMonth.Month, 1).DayOfWeek;
        startDayOfWeek = (startDayOfWeek == 0) ? 7 : startDayOfWeek; // Adjust for Sunday
        int[] week = new int[7];
        for (int day = 1; day <= daysInMonth + startDayOfWeek - 1; day++)
        {
            if (day >= startDayOfWeek)
                week[(day - 1) % 7] = day - startDayOfWeek + 1;

            if (day % 7 == 0 || day == daysInMonth + startDayOfWeek - 1)
            {
                calendar.Add(week);
                week = new int[7];
            }
        }
        FetchEventDays();
    }

    async void FetchEventDays()
    {
       
        eventDays.Clear(); // Clear the list before populating with new event days

        List<EventClass> eventDates = await Http.GetFromJsonAsync<List<EventClass>>("/api/event");
        eventDays = eventDates
            .Where(d => d.DateTime.HasValue && d.DateTime.Value.Year == currentMonth.Year && d.DateTime.Value.Month == currentMonth.Month)
            .Select(d => d.DateTime.Value.Day)
            .ToList();
        
    }
    void UpdateMonth()
    {
        int monthNumber = Array.IndexOf(CultureInfo.CurrentCulture.DateTimeFormat.MonthNames, selectedMonth) + 1;
        currentMonth = new DateTime(selectedYear, monthNumber, 1);
        GenerateCalendar();
    }

    void OnYearChange(int value)
    {
        selectedYear = value;
        UpdateMonth();
    }

    void OnMonthChange(string value)
    {
        selectedMonth = value;
        UpdateMonth();
    }
    async Task OpenDialog(string day)
    {
        if (!string.IsNullOrEmpty(day))
        {
            DateTime selectedDate = new DateTime(currentMonth.Year, currentMonth.Month, int.Parse(day));
            var parameters = new DialogParameters();
            parameters.Add("SelectedDate", selectedDate);

            var dialog = DialogService.Show<EventDialogt>("Event Dialog", parameters);
            var result = await dialog.Result;
        }
    }
}
